---
title: "Spread among technical replicates based on # of detections or taxon"
author: "Ramon Gallego, Helen Casendino, Kai Vennemann, Joe Duprey"
date: "1/21/2022"
output: html_document
---

```{r setup & dependencies, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(ggplot2)
```

# Read in Data 

```{r read in data}
raw_reads <- read_csv(here("special_issue_manuscript/data/gallego_all_data.csv"))
hash_annotated <- read_csv(here("special_issue_manuscript/data/gallego_hash_annotated.csv"))
```

# Exploring (<3) detections

```{r Per taxon, percentage of technical replicates that are 0; kingdom}
prop.drops <- function(wide_df, kingdoms){

  proportion_drops <- data.frame(kingdom = kingdoms, proportionDrops = NA)
  for(i in 1:length(kingdoms)){
    
    df <- wide_df %>% filter(kingdom == kingdoms[i]) %>% 
         pivot_longer(c("1", "2", "3"), names_to = "tech", values_to = "reads")
  
   proportion_drops[i,2] <-length(which(df$reads == 0))/nrow(df)
  }
  
  print("SAMPLE SIZES:")
  for(i in kingdoms){
    one_kingdom <- wide_df %>%
      filter(kingdom %in% i)
    
    print(paste(i, nrow(one_kingdom)))
   }
    return(proportion_drops)
}

all_king_drops <- prop.drops(wide_reads_annotated, c("Viridiplantae", "Stramenopiles", "Haptophyceae", "Metazoa", "Rhodophyta","Dinoflagellates") )

ggplot(all_king_drops, aes(x = kingdom, y = proportionDrops)) +
  geom_bar(stat="identity") + ylab("Proportion of Dropped Technical Replicates")
```

```{r phylum}

by_phylum_drops <- function(wide_df, phyla){

  proportion_drops <- data.frame(phylum = phyla, proportionDrops = NA)
  for(i in 1:length(phyla)){
    df <- wide_df %>% filter(phylum == phyla[i]) %>% 
         pivot_longer(c("1", "2", "3"), names_to = "tech", values_to = "reads")
  
   proportion_drops[i,2] <-length(which(df$reads == 0))/nrow(df)

  }
  
  print("SAMPLE SIZES:")
  for(i in phyla){
    one_phylum <- wide_df %>%
      filter(phylum %in% i)
    
    print(paste(i, nrow(one_phylum)))
   }
  
    return(proportion_drops)
}

print(unique(wide_reads_annotated$phylum))

phyla_bar_df_1 <- by_phylum_drops(wide_reads_annotated, c("Annelida", "Chordata", "Porifera", "Arthropoda","Rotifera", "Mollusca", "Bryozoa", "Cnidaria", "Echinodermata", "Bacillariophyta"))

ggplot(phyla_bar_df_1, aes(x = phylum, y = proportionDrops)) +
  geom_bar(stat="identity")  + ylab("Proportion of Dropped Technical Replicates")
```

```{r arthropods}

just_arthropods <- wide_reads_annotated %>%
  filter(phylum %in% c("Arthropoda"))

by_order_drops <- function(wide_df, orders){

  proportion_drops <- data.frame(order = orders, proportionDrops = NA)
  for(i in 1:length(orders)){
    df <- wide_df[wide_df$order == orders[i],]
  
    dropouts <- c(which(df$`1` == 0),
                which(df$`2` == 0),
                which(df$`3` == 0))
   proportion_drops[i,2] <- length(unique(dropouts)) / nrow(df)
  }
  
  print("SAMPLE SIZES:")
  for(i in orders){
    one_order <- wide_df %>%
      filter(order %in% i)
    
    print(paste(i, nrow(one_order)))
   }
  
    return(proportion_drops)
}

print(unique(just_arthropods$order))

arthropod_breakdown <- by_order_drops(wide_reads_annotated, c("Calanoida", "Sessilia", "Diptera", "Decapoda",      
                                                              "Harpacticoida", "Kentrogonida", "Amphipoda",    
                                                              "Cyclopoida", "Diplostraca", "Lepidoptera",
                                                              "Sarcoptiformes", "Isopoda", "Neelipleona",
                                                              "Euphausiacea", "Poecilostomatoida"))

# is this the behavior we expect?? - joe 
ggplot(arthropod_breakdown, aes(x = order, y = proportionDrops)) +
  geom_bar(stat="identity") 
```

