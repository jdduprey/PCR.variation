---
title: "Exploring various methods of assessing dissimilarity between communities within different PCR replicates"
author: "Joe Duprey, Helen Casendino"
date: "7/21/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r Dependencies, include=FALSE}
library(tidyverse)
library(vegan)
```

Our broad goal here is to try 3 different methods — Jaccard, Bray-Curtis, and Beta Diversity — to quantify dissimilarity in the "communities" of PCR replicates 1, 2 and 3. 

We start with clean.tech.table.csv (from divide.reps_calc.eDNA.index.Rmd), which includes triplicates, not duplicates. Joe and I think the eDNA index function used isn't perfect yet, but we'll work with it for now. 

```{r Load data}
full.indexed.reads <- read.csv("../data/clean.tech.table.csv")
```

Step 1: Try Bray Curtis 

First, convert to community matrix.

```{r data to matrix}
index.reads <- full.indexed.reads[,6:8] # only eDNA index values
index.mat<- t(index.reads) # columns = PCR rep number, rows = Hashes, values = nReads
```


"na.rm = Pairwise deletion of missing observations when computing dissimilarities." For the BC test, we should probably remove whole observations where one value is NA. When a value is NA, pretty sure it means that the Hash in question was not present in any of the bottles within that specific PCR replicate (1, 2 or 3), and was only found in the other two PCR sets. 

```{r BCD between PCR runs across samples}
vegdist(index.mat, method="bray", na.rm = T)
```

All yielding pretty similar BC values (~0.63). But I'm worried that we might be glossing over some variability between bottles (ie, variation b/w PCR rep 1, 2 and 3 might be different based on the sample). Let's try getting PCR BC dissimilarity by sample. 

```{r BCD between PCR runs between samples}

 #bioVector = list of unique biological replicate IDs, indexCols = col numbers of eDNA index values (by PCR #). df needs to have 3 columns corresponding to eDNA indices of different PCR runs

bray_by_sample <- function(df, bioVector, indexCols){  
  
    bray.mat <- matrix(NA, nrow = length(bioVector), ncol = 3, dimnames = list(bioVector, c(1.2,2.3,1.3))) # different PCR rep combinations
  
  for(i in 1:length(bioVector)){
    sample.tib <- df[df$bio == bioVector[i],indexCols]
    bray.tib <- t(sample.tib)
    bray.results <- as.matrix(vegdist(bray.tib, method="bray", na.rm = T))
    bray.mat[i,] <- c(bray.results[1,2], bray.results[3,2], bray.results[1,3]) # PCR 1&2, 2&3, 1&3
  }
    return(bray.mat)
}

bray_by_sample(full.indexed.reads, unique(full.indexed.reads$bio), c(6:8))

```

I don't want to overfocus on variability between samples, because that's not what we're interested in. So maybe the chunk above is totally obsolete. However, I wonder if doing a permanova between the three *distributions* of BCDs (separated by sample) is more informative than just looking at 3 BCD values (for each PCR combination, across samples). ????

```{r PERMANOVA on 3 BCD distributions}


```



Step 2: Try Beta Diversity

Working on figuring this out...why the NAs? 

```{r Beta Div test}
betadiver(index.mat, method = 1)
```
