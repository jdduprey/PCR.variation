---
title: "joe.centroid.calc"
author: "Helen Casendino, Joe Duprey"
date: "7/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(vegan)
library(reshape)
```

The goal of this script is the following in psuedocode
1) figure out how to calculate group centroids with vegan::vegdist
2) get Bray-curtis dissimilarities between each PCR rep of a biological sample and the bio group centroid
3) eliminate reads by proportion - OR RANK-proprotion i think - and plot the dissimilarity for each bio rep
4) to create Eily's nifty dream scatter plot 

```{r}
# load data 
full.proportion.reads <- read.csv("../data/PCR.proportions.csv")
```

```{r}
prop.reads <- full.proportion.reads[,4:6] # only eDNA proportion values
prop.mat<- t(prop.reads) # columns = Hashes, rows = PCR #, values = nReads proportions
```

```{r}
#bioVector = list of unique biological replicate IDs, indexCols = col numbers of eDNA proportion values (by PCR #). df needs to have 3 columns corresponding to eDNA proportions of different PCR runs

bray_by_sample <- function(df, bioVector, indexCols){  
  
    bray.mat <- matrix(NA, nrow = length(bioVector), ncol = 3, dimnames = list(bioVector, c(1.2,2.3,1.3)))
    centroid.mat <- matrix(NA, nrow = length(bioVector), ncol = 3, dimnames = list(bioVector, c('rep1','rep2','rep3')))
    # different PCR rep combinations
  
  for(i in 1:length(bioVector)){
    sample.tib <- df[df$bio == bioVector[i],indexCols]
    bray.tib <- t(sample.tib)
    bray.results <- as.matrix(vegdist(bray.tib, method="bray", na.rm = T))
    
    ### MODIFIED CODE TO GET DISTANCE OF EACH TECH REPLICATE TO CENTROID **needs review**
    dis <- vegdist(bray.tib, method="bray", na.rm=T) # bray distance object
    groups <- factor(rep(1,3), labels=bioVector[i]) # groups, this is just vector of 3 with the bio's name?
    mod <- betadisper(dis, groups) # calculate the distance 
    #print(mod$distances) 
    
    #bray.mat[i,] <- c(bray.results[1,2], bray.results[3,2], bray.results[1,3]) # PCR 1&2, 2&3, 1&3
    centroid.mat[i,] <- mod$distances
  }
    return(centroid.mat)
}

centroid.mat <- bray_by_sample(full.proportion.reads, unique(full.proportion.reads$bio), c(4:6))
```
Lets visualize the distribution of distances to the biological group centroids!
```{r}


long.cent <- melt(centroid.mat, varnames=c('bio','tech'))

hist(long.cent$value, breaks=30)
# par(mfrow = c(1, 3))
# hist(bray.output[,1], main="PCRs 1 & 2", xlab="BCD", ylim=c(0,60), col = "orange") 
# hist(bray.output[,2], main="PCRs 2 & 3", xlab="BCD", ylim=c(0,60), col = "orange") 
# hist(bray.output[,3], main="PCRs 1 & 3", xlab="BCD", ylim=c(0,60), col = "orange")
```

