---
title: "rareSp.dissimilarity"
author: "Helen Casendino"
date: "7/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r Dependencies, include=FALSE}
library(tidyverse)
library(vegan)
library(gridExtra)
```

This code will look at the impact of rare species on dissimilarity between PCR replicates. We'll start with PCR.proportions.clean.csv, which has the proportions of each hash by PCR replicate (ONLY triplicate PCR samples) and biological samples with really 1 low read PCR replicate are removed (put into PCR.duplic.proportions.csv). 

```{r load in data}
trip.proportion.reads <- read.csv('../data/PCR.proportions.clean.csv')

dup.proportion.reads <- read.csv('../data/PCR.duplic.proportions.csv')
```

Below is my start to making the subsetting loop with BCD centroids for each sample. So, for each sample, we'll have a rank of most common hashes to least common. We will subset this with varying exclusion proportions (ie, removing bottom 1% of hashes, bottom 5%). For each subset, calculate the centroid of 3 pairwise bray curtis dissimilarities: PCRs 1&2, 2%3 and 1&3.   

```{r Function that calculates centroids by sample across rare sp subsets}

# df is a data frame with 6 columns: Miseq_run, bio, Hash, PCR1_prop, PCR2_prop, PCR3_prop
# exclusionProp is a vector of all the subsetting proportions you want. A vector of (0.01, 0.05) means you'll get the PCR centroid for when 1% of the lowest proportion samples are excluded, and when 5% of lowest prop samples are excluded.
# bioVector is a vector of all biological sample IDs in your dataset.

PCRcentroid_bySample <- function(df, exclusionProp, bioVector){
   
  mat <- matrix(NA, nrow = length(exclusionProp), ncol = length(bioVector))
  
  for(j in 1:length(bioVector)){
    
      bioSample <- bioVector[j]
      bioProps_Hashes <- df[df$bio == bioSample,] # to get all PCR props from that one sample
      
      meanProp.acrossPCR <- bioProps_Hashes %>% group_by(Hash) %>% summarise(meanProp.PCR = mean(c(PCR1_prop, PCR2_prop,PCR3_prop))) %>% arrange(desc(meanProp.PCR)) # to get rarity order
      
      for(i in 1:length(exclusionProp)){
       cutoff <- round(length(meanProp.acrossPCR$Hash) - length(meanProp.acrossPCR$Hash)*exclusionProp[i])
        sub.tib <- meanProp.acrossPCR[1:cutoff,]
        sub.tib <- bioProps_Hashes %>% filter(Hash %in% sub.tib$Hash) %>% select(!c(Hash, bio,Miseq_run))
       
         flip.tib <- t(sub.tib)
         dis <- vegdist(flip.tib)
        grouping <- factor(rep(1,3), labels=bioSample)
       
         centroid<- betadisper(dis, group = grouping)
        centroid$distances 
        mat[i,j] <- mean(centroid$distances)
      }
    
    print(j) # progress bar
  }
  return(mat)
}

# returns a matrix with biological replicate as columns and exclusion proportion as rows. 

```

Now let's visualize it with our data

```{r Organize function matrix output}

exclvec<- seq(0,0.5, 0.01)
centroids <- PCRcentroid_bySample(trip.proportion.reads, exclvec, unique(trip.proportion.reads$bio))

mean.centroidDists <- rowMeans(as.data.frame(centroids)) # average distances to centroid of PCR reps for all exclusion proportion values across biological replicates

cutoff.centroid.df <- data.frame(exclusion.prop = exclvec, cent.distance = mean.centroidDists) # combines with exclusion prop vector
```

```{r Plot data}

# histogram of centroid vals for each cutoff 
# par(mfrow= c(3,7)) # depends on # of proportion cutoffs 
#for(i in 1:length(exclvec)){
#  hist(centroids[i,], main="",xlab="",ylab="")
#}

# cutoff proportion vs. distance to centroid
trip.centroids <- ggplot(cutoff.centroid.df, aes(x=exclusion.prop, y=cent.distance, color="orange")) + geom_point() +  theme_minimal() + theme(legend.position = "none") + geom_text(x=0.15, y=0.233,color="black",size=5, label="Triplicates") + xlab("% Rare Species Excluded") + ylab("Distance to Centroid")
```


Let's repeat with duplicate data.

```{r duplicate data}
# same function as above, just with two minor details changed (2 PCRs instead of 3)
PCRcentroid_bySample_dup <- function(df, exclusionProp, bioVector){
  
  mat <- matrix(NA, nrow = length(exclusionProp), ncol = length(bioVector))
  
  for(j in 1:length(bioVector)){
    
    bioSample <- bioVector[j]
    bioProps_Hashes <- df[df$bio == bioSample,] # to get all PCR props from that one sample
    
    meanProp.acrossPCR <- bioProps_Hashes %>% group_by(Hash) %>% summarise(meanProp.PCR = mean(c(PCR1_prop, PCR2_prop))) %>% arrange(desc(meanProp.PCR)) # to get rarity order
    
    for(i in 1:length(exclusionProp)){
      cutoff <- round(length(meanProp.acrossPCR$Hash) - length(meanProp.acrossPCR$Hash)*exclusionProp[i])
      sub.tib <- meanProp.acrossPCR[1:cutoff,]
      sub.tib <- bioProps_Hashes %>% filter(Hash %in% sub.tib$Hash) %>% select(!c(Hash, bio,Miseq_run))
      
      flip.tib <- t(sub.tib)
      dis <- vegdist(flip.tib)
      grouping <- factor(rep(1,2), labels=bioSample)
      
      centroid<- betadisper(dis, group = grouping)
      centroid$distances 
      mat[i,j] <- mean(centroid$distances)
    }
    
    print(j) # progress bar
  }
  return(mat)
}

exclvec<- seq(0,0.5, 0.01)
centroids <- PCRcentroid_bySample_dup(dup.proportion.reads, exclvec, unique(dup.proportion.reads$bio))

# same code as above
mean.centroidDists <- rowMeans(as.data.frame(centroids)) 
cutoff.centroid.df <- data.frame(exclusion.prop = exclvec, cent.distance = mean.centroidDists) 

#plot
dup.centroids <- ggplot(cutoff.centroid.df, aes(x=exclusion.prop, y=cent.distance, color="firebrick4")) + geom_point() +  theme_minimal() + theme(legend.position = "none") + geom_text(x=0.15, y=0.1625,color="black",size=5, label="Duplicates") + xlab("% Rare Species Excluded") + ylab("Distance to Centroid")
```

Let's plot both our duplicate and triplicate data:

```{r plot both dup and trip centroid output}
grid.arrange(trip.centroids, dup.centroids, ncol=2)
```