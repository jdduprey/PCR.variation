---
title: "rareSp.dissimilarity"
author: "Helen Casendino"
date: "7/31/2021"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r Dependencies, include=FALSE}
library(tidyverse)
library(vegan)
library(gridExtra)
```


For each biological replicate, this code will loop through flat hash proportion cutoffs, and look at how the mean distance to the centroid (between 3 pairwise comparisons: PCR 1&2, 2&3, 1&3) changes by removing rare hashes (below a certain proportion threshold). We will also be keeping track of what percentage of Hashes are being removed in each cutoff. 

## Step 1: Read in the data. 

 - trip.proportion.reads = the proportions of each hash by PCR replicate (ONLY triplicate PCR samples) and biological samples with really 1 low read PCR replicate are removed
 - dup.proportion.reads = the proportions of each hash by PCR replicate (ONLY duplicate PCR samples and triplicate PCR samples that had one replicate chopped bc of low total reads)

```{r load in data}
trip.proportion.reads <- read.csv('../data/PCR.proportions.clean.csv')

dup.proportion.reads <- read.csv('../data/PCR.duplic.proportions.csv')
```


## Step 2: Create and run 2 functions (1 for triplicates, 1 for duplicates), getting distance to centroid for different cutoffs

 - gets mean distance to centroid for 3 different PCR pairwise comparisons, by biological replicate, for different flat Hash proportion cutoffs.
 - For each sample, Hash proportiono cutoffs are made by getting average proportion for each hash across PCR replicates, and chopping Hashes from the data that are at or below the proportion cutoff
 - also keeps track of how many hashes are being removed in each cutoff

```{r Functions that calculate centroids by sample across rare sp subsets (for trip and dup PCRs)}
# Function calls: 
# a) df is a data frame with columns: Miseq_run, bio, Hash, PCR1_prop, PCR2_prop (and PCR3_prop for triplicates)
# b) cutoffs is a vector of all the subsetting proportion cutoffs you want. A vector of (0.01) means you'll get the PCR centroid for when all Hashes with mean proportions at or below 0.01 will be chopped
# c) bioVector is a vector of all biological sample IDs in your dataset.

# Function output: 
# A list with two matrices: 
# 1) In each bio sample, for each proportion cutoff, the percent of Hashes removed (rows = cutoffs, cols = bio sample)
# 2) In each bio sample, for each proportion cutoff, the mean distance to the centroid for 3 pairwise PCR comparisons (rows = cutoffs, cols = bio sample)

# Function for PCR triplicates 

PCRcentroids_trip <- function(df, cutoffs, bioVector){
  
  DistCentroid_ExclPercent <- list(excl.percents = matrix(NA, nrow = length(cutoffs), ncol = length(bioVector)),
                                   centroid.dists = matrix(NA, nrow = length(cutoffs), ncol = length(bioVector)))
  
  for(j in 1:length(bioVector)){
    
    bioSample <- bioVector[j]
    bioProps_Hashes <- df[df$bio == bioSample,] # to get all PCR props from that one sample
    
    meanProp.acrossPCR <- bioProps_Hashes %>% group_by(Hash) %>% summarise(meanProp.PCR = mean(c(PCR1_prop, PCR2_prop,PCR3_prop))) %>% arrange(desc(meanProp.PCR)) # to get rarity order
    
    for(i in 1:length(cutoffs)){
      sub.tib <- meanProp.acrossPCR %>% filter(meanProp.PCR > cutoffs[i]) # chop hashes below proportion cutoff
     
        DistCentroid_ExclPercent[[1]][i,j] <- 1 - (length(sub.tib$Hash)/length(bioProps_Hashes$Hash)) #for each cutoff in each bio rep, keeps track of what percent of Hashes were removed with cutoff in exclusion percent matrix
      
      sub.tib <- bioProps_Hashes %>% filter(Hash %in% sub.tib$Hash) %>% select(!c(Hash, bio,Miseq_run)) # all PCR props corresponding to remaining hashes
  
      flip.tib <- t(sub.tib)
      dis <- vegdist(flip.tib)
      grouping <- factor(rep(1,3), labels=bioSample)
      centroid<- betadisper(dis, group = grouping)
      DistCentroid_ExclPercent[[2]][i,j] <- mean(centroid$distances) # put into centroid distances matrix
    }
    print(j) # progress bar
  }
  return(DistCentroid_ExclPercent)
}

# Function for PCR duplicates 

PCRcentroids_dup <- function(df, cutoffs, bioVector){
  
  DistCentroid_ExclPercent <- list(excl.percents = matrix(NA, nrow = length(cutoffs), ncol = length(bioVector)),
                                   centroid.dists = matrix(NA, nrow = length(cutoffs), ncol = length(bioVector)))
  
  for(j in 1:length(bioVector)){
    
    bioSample <- bioVector[j]
    bioProps_Hashes <- df[df$bio == bioSample,] # to get all PCR props from that one sample
    
    meanProp.acrossPCR <- bioProps_Hashes %>% group_by(Hash) %>% summarise(meanProp.PCR = mean(c(PCR1_prop, PCR2_prop))) %>% arrange(desc(meanProp.PCR)) # to get rarity order
    
    for(i in 1:length(cutoffs)){
      sub.tib <- meanProp.acrossPCR %>% filter(meanProp.PCR > cutoffs[i]) # chop hashes below proportion cutoff
     DistCentroid_ExclPercent[[1]][i,j] <- 1 - (length(sub.tib$Hash)/length(bioProps_Hashes$Hash)) #for each cutoff in each bio rep, keeps track of what percent of Hashes were removed with cutoff in exclusion percent matrix
   
       sub.tib <- bioProps_Hashes %>% filter(Hash %in% sub.tib$Hash) %>% select(!c(Hash, bio,Miseq_run))
      
      flip.tib <- t(sub.tib)
      dis <- vegdist(flip.tib)
      grouping <- factor(rep(1,2), labels=bioSample)
      
      centroid<- betadisper(dis, group = grouping)
      DistCentroid_ExclPercent[[2]][i,j] <- mean(centroid$distances) # put into centroid distances matrix
    }
    print(j) # progress bar
  }
  return(DistCentroid_ExclPercent)
}
```

Now let's get output for duplicate and triplicate data. 

```{r Function output for dup and trip data}
trip.output <- PCRcentroids_trip(trip.proportion.reads, seq(0,0.0001, 0.000001),unique(trip.proportion.reads$bio))

dup.output <- PCRcentroids_dup(dup.proportion.reads, seq(0,0.0001, 0.000001),unique(dup.proportion.reads$bio))
```


## Step 3: Plotting.

```{r triplicate plotting}

### 1) Graph of centroid distances averaged over bio samples

mean.centroidDists <- rowMeans(as.data.frame(trip.output$centroid.dists)) # average distances to centroid of PCR reps for all exclusion proportion values across biological replicates
cutoff.centroid.df <- data.frame(cutoffs = seq(0,0.0001, 0.000001), cent.distance = mean.centroidDists) # combines with cutoffs

# also add layer that shows average percent of Hashes chopped for each cutoff
mean.exclpercent <- rowMeans(as.data.frame(trip.output$excl.percents)) *100 #percents, not proportions
exclpercent.df <- data.frame(cutoffs = seq(0,0.0001, 0.000001), exclperc = mean.exclpercent)

# with two y axes (1 = percent hashes excluded, 2 = dist to centroid)
trip.plot.A <- ggplot() +  theme_minimal() + 
  geom_bar(mapping = aes(x = exclpercent.df$cutoffs, y = exclpercent.df$exclperc), stat = "identity", fill = "gainsboro") +
  geom_point(mapping = aes(x = cutoff.centroid.df$cutoffs, y = cutoff.centroid.df$cent.distance*100), size = .5, color = "darkblue") +
  scale_x_continuous(name = "Proportion Cutoff") +
  scale_y_continuous(name = " %  Excluded",
      labels = function(b) { paste0(b, "%")}, 
    sec.axis = sec_axis(~./100, name = " Distance to Centroid")) + 
  theme(axis.title.y = element_text(color = "gray48"),
      axis.title.y.right = element_text(color = "darkblue"))

# with one axis (Dist to centroid)
trip.plot.B <-  ggplot() +  theme_minimal() + geom_point(mapping = aes(x = cutoff.centroid.df$cutoffs, y = cutoff.centroid.df$cent.distance), size = .5, color = "darkblue") + theme(legend.position = "none") + theme(axis.title.y = element_text(color = "darkblue")) + scale_y_continuous(name = " Distance to Centroid") + xlab("Proportion Cutoff") 

# next I want to make violin plots to see how distribution of hashes chopped across bio replicates changes with proportin cutoff 

  ggplot(aes(Subject, Reaction)) +
  geom_violin()+
  theme(aspect.ratio = .33)  # change the aspect ratio to make long and wide
```


```{r duplicate plotting}
mean.centroidDists <- rowMeans(as.data.frame(dup.output$centroid.dists)) # average distances to centroid of PCR reps for all exclusion proportion values across biological replicates
cutoff.centroid.df <- data.frame(cutoffs = seq(0,0.0001, 0.000001), cent.distance = mean.centroidDists) # combines with cutoffs

# also add layer that shows average percent of Hashes chopped for each cutoff
mean.exclpercent <- rowMeans(as.data.frame(dup.output$excl.percents)) *100 #percents, not proportions
exclpercent.df <- data.frame(cutoffs = seq(0,0.0001, 0.000001), exclperc = mean.exclpercent)

# with two y axes (1 = percent hashes excluded, 2 = dist to centroid)
dup.plot.A <- ggplot() +  theme_minimal() + 
  geom_bar(mapping = aes(x = exclpercent.df$cutoffs, y = exclpercent.df$exclperc), stat = "identity", fill = "gainsboro") +
  geom_point(mapping = aes(x = cutoff.centroid.df$cutoffs, y = cutoff.centroid.df$cent.distance*100), size = .5, color = "darkblue") +
  scale_x_continuous(name = "Proportion Cutoff") +
  scale_y_continuous(name = " %  Excluded",
      labels = function(b) { paste0(b, "%")}, 
    sec.axis = sec_axis(~./100, name = " Distance to Centroid")) + 
  theme(axis.title.y = element_text(color = "gray48"),
      axis.title.y.right = element_text(color = "darkblue"))

# with one axis (Dist to centroid)
dup.plot.B <-  ggplot() +  theme_minimal() + geom_point(mapping = aes(x = cutoff.centroid.df$cutoffs, y = cutoff.centroid.df$cent.distance), size = .5, color = "darkblue") + theme(legend.position = "none") + theme(axis.title.y = element_text(color = "darkblue")) + scale_y_continuous(name = " Distance to Centroid") + xlab("Proportion Cutoff") 
```


```{r other plots}
### 2) Graph of centroid distances without averaging bio samples

#centroidDists <- as.data.frame(trip.output)
#colnames(centroidDists) <- unique(trip.output$bio)
#centroidDists$exclprop <- exclvec

#centroid.scatplot.df <- centroidDists %>% pivot_longer(unique(trip.proportion.reads$bio), #names_to = "bio", values_to = "centroid")

# actual scatter plot 
#centroid.scatplot.trip <- ggplot(centroid.scatplot.df) + geom_point(aes(x=exclprop, y=centroid, color=bio)) +  theme_minimal()  + theme(legend.position = "none") + xlab("% Rare Species Excluded") + ylab("Distance to Centroid")

## Let's plot both our duplicate and triplicate data.
#grid.arrange(trip.centroids, dup.centroids, centroid.scatplot.trip, centroid.scatplot.dup, ncol=2, nrow=2)
```
